<!DOCTYPE html>
<html lang="ru">
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Автоматизация рутины приоритетнее давления массой">
    <meta name="author" content="Сергей Пирогов">
    <meta name="HandheldFriendly" content="True" />

    <meta property="og:site_name" content="Заметки Автоматизатора">
    <meta property="og:type" content="article">
    <meta property="og:title" content="JSON рандомизатор">
    <meta property="og:image" content="../../images/blog-logo.png"/>

       <meta property="og:description" content="История о рандомизации JSON"/>

    <title>Заметки Автоматизатора</title>

    <link rel="canonical" href="https://getbootstrap.com/docs/4.0/examples/album/">

    <!-- Bootstrap core CSS -->
    <link href="../../css/bootstrap.css" rel="stylesheet">
    <link rel="stylesheet" href="../../css/font-awesome.min.css">
    <!-- Custom styles for this template -->
    <link href="../../css/album.css" rel="stylesheet">
    <link href="../../css/main.css" rel="stylesheet">

    <script>
           (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
           (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
           m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
           })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

           ga('create', 'UA-57010828-1', 'auto');
           ga('send', 'pageview');
    </script>
  <body>
<header>
      <nav class="navbar fixed-top navbar-expand-lg navbar-dark bg-dark">
        <div class='container'>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarTogglerDemo01" aria-controls="navbarTogglerDemo01" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarTogglerDemo01">
          <ul class="navbar-nav mr-auto mt-2 mt-lg-0">
            <li class="nav-item">
              <a class="nav-link" href="/">Главная <span class="sr-only">(current)</span></a>
            </li>

          </ul>
          <ul class="navbar-nav">
             <li class="nav-item">
               <a class="nav-link" href="https://soundcloud.com/qaguild">Подкаст</a>
             </li>
             <li class="nav-item">
               <a class="nav-link" href="https://tttttt.me/automation_remarks">Телеграм</a>
             </li>
             <li class="nav-item">
               <a class="nav-link" href="/archive.html">Архив</a>
             </li>
          </ul>
        </div>
        </div>
      </nav>
</header>
	<div class="album py-5 bg-light">
       <div class="post-container container">
            <main class="content" role="main">
                <article class="post">
                    <div class="inner inner-post">
                        <div id="push">
                            <header class="post-header">
                                <span class="post-meta">
                                    <span class="post-author">
                                        <a href="/author/index.html">Сергей Пирогов</a>
                                    </span> |
                                    <span class="post-date">
                                        26/11/2017
                                    </span>
                                </span>
                                <div class="clear"></div>
                                <h1 class="post-title">JSON рандомизатор</h1>
                            </header>

                            <section class="post-content">
                                <div class="paragraph">
<p>Привет! Подоспела очередная порция годноты. В этот раз
расскажу о проблеме рандомизации JSON и способе ее решения.
Сразу спойлер: описанный способ подходит не только для JSON, поэтому можно дочитывать заметку до конца.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcR9yXDTICCdyVcv--Xdule6W_utrnacgseImIMaasrXqo4sqKfD" alt="images?q=tbn:ANd9GcR9yXDTICCdyVcv  Xdule6W utrnacgseImIMaasrXqo4sqKfD">
</div>
</div>
<div class="paragraph">
<p>Давайте для начала определимся с проблемой, которую я буду решать. Представим проект, у которого есть
фронтенд, который общается с бекендом посредством REST API. На таком проекте REST API мы используем для прекондишинов:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Test
public void testCanEditUser(){
    String userEmail = UserApi.createUserForTest()

    User newUserData = User()
        .withName("Ivan")
        .withEmail("test@gmail.com")
        .withPhone("+456789453")

    open(EditUserPage.class)
        .findUser(userEmail)
        .toEditMode()
        .setData(newUserData)
        .save()
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>На первый взгляд, все достаточно удобно и просто. Суть проблемы кроется именно в прекондишине <code>UserApi.createUserForTest()</code>.
В моем случае для создания юзера на эндпоинт нужен запрос с таким  <strong>body</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-json" data-lang="json">{
  "emails": [
    {
      "emailTypeId": 82,
      "email": "test_person@email.com",
      "comment": "",
      "isDefault": true
    }
  ],
  "addresses": [
    {
      "isShippingDefault": true,
      "isBillingDefault": true,
      "addressTypeId": 80,
      "countryId": 3,
      "cityId": 2,
      "isGeneralInfo": true
    }
  ],
  "confidenceId": 120,
  "income": 0,
  "languageCode": "en",
  "lastName": "Ivanov",
  "name": "Test",
  "netWorth": 0,
  "nickName": "Ivan",
  "sexId": 130,
  "liquidAssets": 0,
  "employeeId": 1
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Достаточно сложная структура с кучей полей. Наверное, на многих проектах можно встретить такую ситуацию.
Для того, чтобы сделать тест, описанный выше, перезапускаемым, нам нужно некоторые значения полей, например, email, делать
уникальными, иначе мы получим ошибку валидации.</p>
</div>
<div class="paragraph">
<p>Можно рандомизировать поле имейл:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">UserDto userDto = JsonUtils.getUser("user.json",UserDto.class);
userDto.setEmails(Arrays.asList(EmailDto().withEmail(RandomUtils.nextEmail())));

UserApi.addNewUser(userDto);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Такой подход работает, если нам нужно рандомизировать одно поле. Если мы хотим делать все рандомно, то тут - дрова.</p>
</div>
<div class="paragraph">
<p>Упершись в эту проблему, я начал искать решение. Мне хотелось сделать так:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-json" data-lang="json">{
  "emails": [
    {
      "emailTypeId": 82,
      "email": "{{ email }}",
      "comment": "",
      "isDefault": true
    }
  ]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Просто ставить плейсхолдер, а при диссериализции получать JAVA-объект с уже рандомизованным email.
Конечно, можно было это легко сделать: <strong>.replaceAll("{{ email }}",RandomUtils.nextEmail())</strong>.</p>
</div>
<div class="paragraph">
<p>Приколько, но недостаточно гибко. А если я захочу рандомизиовать поле phone? Мне что теперь идти и дописывать код?</p>
</div>
<div class="paragraph">
<p>Гуглеж натолкнул меня на один интересный сайт <a href="https://www.json-generator.com/">https://www.json-generator.com/</a>.
Отличная идея и реализация, но у него нету API, а подобное я нашел только для NodeJS. Мне же нужно для Java.</p>
</div>
<div class="paragraph">
<p>Присмотревшись к своей хотелке, я подумал: блин, так можно же взять template engine и дело в шляпе.</p>
</div>
<div class="paragraph">
<p>Покумекав еще пару дней, я нашел отличный инструмент <a href="http://jtwig.org/">jTwig</a>. Очень простой и легковесный
template engine для Java.</p>
</div>
<div class="paragraph">
<p>Пример работы с ним выглядит так:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">JtwigTemplate template = JtwigTemplate.classpathTemplate("templates/user.json");
JtwigModel model = JtwigModel.newModel()
            .with("faker", new Faker());

String json = template.render(model);

UserDto userdto = getEntity(json, User.class);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Во второй строке я применил библиотеку <a href="https://github.com/DiUS/java-faker">java-faker</a>.</p>
</div>
<div class="paragraph">
<p>Темплейты теперь можно писать так:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-json" data-lang="json">{
  "name": "{{ faker.name().firstName() }}",
  "lastName": "{{ faker.name().lastName() }}",
  "addresses": [
    "{{ faker.address().streetAddress() }}",
    "{{ faker.address().streetAddress() }}"
  ]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Да-да, jTwig умеет вызывать Java методы - мегафича.</p>
</div>
<div class="paragraph">
<p>Теперь, имея такую функциональность, те поля, которые нужно, мы параметризуем и после диссериализации
получаем готовые Java-объекты.</p>
</div>
<div class="paragraph">
<p><strong>P/S</strong> Описанный способ отлично работает на моем проекте. К сожалению, jTwig не умеет вызывать java-методы с параметрами:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-json" data-lang="json">{
    "id": "{{ randomIntBetween(7, 10) }}"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>В таких случаях мы велосипедируем, но я знаю, что эту проблему можно решить, используя вместо jTwig
какой-то другой template engine. К примеру, <strong>Freemarker</strong>, <strong>Thymeleaf</strong> или <strong>Pebble</strong>.</p>
</div>
<div class="paragraph">
<p>На этом у меня все. Оставайтесь на связи, подписывайтесь на мою группу в <a href="https://www.facebook.com/automationremarks/">Facebook</a>.</p>
</div>
                            </section>

                            <footer class="post-footer">
                                    <div class="post-tags">
                                            <a class="btn btn-sm btn-outline-dark tag" href="/tags/Java.html">Java</a>
                                            <a class="btn btn-sm btn-outline-dark tag" href="/tags/Тестовый-фреймворк.html">Тестовый фреймворк</a>
                                    </div>

                            </footer>

                            <div class="row">
                                  <div class="col-md-12">
                                        <div class='related-posts-holder'>
                                             <h2 class="related-posts-header">Похожие заметки:</h2>

                                                 <div class="card-deck">
                                                        <div class="card bg-light mb-3">
                                                            <div class="card-body d-flex flex-column">
                                                              <p class="card-text">
                                                                      <small class="text-muted"><span class="post-date">22 April 2020</span></small>
                                                              </p>
                                                              <h5 class="card-title"><a href="/2020/qaguild-live26/index.html">QAGuild live #26: Selenium UI Automation плагин в Idea для тестировщика</a></h5>

                                                              <hr>

                                                              <p class="card-text">
                                                                   Обзор на Selenium UI Automation плагин в Idea
                                                              </p>

                                                              <a href="/2020/qaguild-live26/index.html" class="mt-auto card-link">
                                                                Читать<i class="fa fa-chevron-right ml-1"></i>
                                                              </a>
                                                            </div>
                                                        </div>
                                                        <div class="card bg-light mb-3">
                                                            <div class="card-body d-flex flex-column">
                                                              <p class="card-text">
                                                                      <small class="text-muted"><span class="post-date">21 April 2020</span></small>
                                                              </p>
                                                              <h5 class="card-title"><a href="/2020/qaguild-s03e06/index.html">QAGuild S03E06: Про работу тестировщиков из дома</a></h5>

                                                              <hr>

                                                              <p class="card-text">
                                                                   Подкаст про работу из дома
                                                              </p>

                                                              <a href="/2020/qaguild-s03e06/index.html" class="mt-auto card-link">
                                                                Читать<i class="fa fa-chevron-right ml-1"></i>
                                                              </a>
                                                            </div>
                                                        </div>
                                                        <div class="card bg-light mb-3">
                                                            <div class="card-body d-flex flex-column">
                                                              <p class="card-text">
                                                                      <small class="text-muted"><span class="post-date">18 April 2020</span></small>
                                                              </p>
                                                              <h5 class="card-title"><a href="/2020/qaguild-live27/index.html">QAGuild live #27: Selenide на Kotlin для тестирования UI</a></h5>

                                                              <hr>

                                                              <p class="card-text">
                                                                   Selenide на Kotlin для тестирования UI
                                                              </p>

                                                              <a href="/2020/qaguild-live27/index.html" class="mt-auto card-link">
                                                                Читать<i class="fa fa-chevron-right ml-1"></i>
                                                              </a>
                                                            </div>
                                                        </div>
                                                        <div class="card bg-light mb-3">
                                                            <div class="card-body d-flex flex-column">
                                                              <p class="card-text">
                                                                      <small class="text-muted"><span class="post-date">10 April 2020</span></small>
                                                              </p>
                                                              <h5 class="card-title"><a href="/2020/qadof/index.html">Online QA BOF</a></h5>

                                                              <hr>

                                                              <p class="card-text">
                                                                   QA BOF
                                                              </p>

                                                              <a href="/2020/qadof/index.html" class="mt-auto card-link">
                                                                Читать<i class="fa fa-chevron-right ml-1"></i>
                                                              </a>
                                                            </div>
                                                        </div>
                                                 </div>
                                         </div>
                                  </div>
                                  <div class="col-md-6">

                                  </div>
                            </div>
                        </div>
                    </div>
                </article>
            </main>
       </div>
    </div>
    <footer class="text-muted page-footer">
      <div class="container">

      </div>
    </footer>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="../../js/jquery-3.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script>window.jQuery || document.write('<script src="../../assets/js/vendor/jquery-slim.min.js"><\/script>')</script>
    <script src="../../js/popper.js"></script>
    <script src="../../js/bootstrap.js"></script>
    <script src="../../js/holder.js"></script>

    </body>
</html>