<!DOCTYPE html>
<html lang="ru">
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Автоматизация рутины приоритетнее давления массой">
    <meta name="author" content="Сергей Пирогов">
    <meta name="HandheldFriendly" content="True" />

    <meta property="og:site_name" content="Заметки Автоматизатора">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Kotlin для автотестов: боевой опыт">
    <meta property="og:image" content="../../images/blog-logo.png"/>

       <meta property="og:description" content="Мой опыт написания автотестов на Котлине"/>

    <title>Заметки Автоматизатора</title>

    <link rel="canonical" href="https://getbootstrap.com/docs/4.0/examples/album/">
    <link href="../../css/github.css" rel="stylesheet">
    <!-- Bootstrap core CSS -->
    <link href="../../css/bootstrap.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <!-- Custom styles for this template -->
    <link href="../../css/album.css" rel="stylesheet">
    <link href="../../css/main.css" rel="stylesheet">

    <script>
           (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
           (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
           m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
           })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

           ga('create', 'UA-57010828-1', 'auto');
           ga('send', 'pageview');
    </script>
  <body>
<header>
      <nav class="navbar fixed-top navbar-expand-lg navbar-dark bg-dark">
        <div class='container'>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarTogglerDemo01" aria-controls="navbarTogglerDemo01" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarTogglerDemo01">
          <ul class="navbar-nav mr-auto mt-2 mt-lg-0">
            <li class="nav-item">
              <a class="nav-link" href="/">Главная <span class="sr-only">(current)</span></a>
            </li>

          </ul>
          <ul class="navbar-nav">
             <li class="nav-item">
               <a class="nav-link" target=blank href="https://soundcloud.com/qaguild">Подкаст</a>
             </li>
             <li class="nav-item">
               <a class="nav-link" target=blank href="https://tttttt.me/automation_remarks">Телеграм</a>
             </li>
             <li class="nav-item">
               <a class="nav-link" href="/archive.html">Архив</a>
             </li>
          </ul>
        </div>
        </div>
      </nav>
</header>
	<div class="album py-5 bg-light">
       <div class="post-container container">
            <main class="content" role="main">
                <article class="post">
                    <div class="inner inner-post">
                        <div id="push">
                            <header class="post-header">
                                <span class="post-meta">
                                    <span class="post-author">
                                        <a href="/author/index.html">Сергей Пирогов</a>
                                    </span> |
                                    <span class="post-date">
                                        17/03/2018
                                    </span>
                                </span>
                                <div class="clear"></div>
                                <h1 class="post-title">Kotlin для автотестов: боевой опыт</h1>
                            </header>

                            <section class="post-content">
                                <div class="paragraph">
<p>Привет, друг! Меня часто просят рассказать о нашей практике написания тестов на Котлине.
Наконец-то я нашел время и решил поделиться своим опытом.</p>
</div>
<div class="paragraph">
<p>Начну с того, что еще в сентябре 2017 года я рассказывал <a href="http://automation-remarks.com/2017/kotlin-without-marketing/index.html">о Котлине на конференции QAFest</a>.
С того времени утекло много воды, кое-что я переосмыслил.</p>
</div>
<div class="paragraph">
<p>Давай сначала поясню мотивацию писать на Котлине. Джава подутомила. Реально, когда ты пишешь тесты, то некоторые
конструкции хотелось бы опустить. Для примера покажу типичный <strong>PageObject</strong> в моих проектах:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@PageUrl("/")
class LoginPage {

  SelenideElement userNameInput = $("#userName");
  SelenideElement passwordInput = $("#password");
  SelenideElement signInBtn = $("#loginBtn")
  public SelenideElement errorMessage = s("#page__loginByEmail &gt; div:nth-child(3) &gt; div")

  public logisAs(User user){
   userNameInput.setValue(user.getName());
   passwordInput.setValue(user.getPassword());
   signInBtn.click();
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Простой класс с полями и методами. Можно холиварить, хорошо так писать или плохо, но я так пишу везде. Для целостности картины
покажу тест:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">class LoginTest {

  @Test
  public void testCanNotLoginWithWrongCredentials(){
     User user = TestData.getUser();

     LoginPage loginPage = open(LoginPage.class);

     loginPage.loginAs(user);
     loginPage.errorMessage.shouldHave(text("Bad credentials"));
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Все достаточто просто и без лишнего. Чтобы упростить написание тестов и убрать некоторые излишества, я <a href="http://automation-remarks.com/2017/lombok/index.html">пробовал использовать
Lombok</a>. С ним, вроде как, все хорошо, кроме плагина для Idea. В общем, использовать можно, но будь готов к
сюрпризам.</p>
</div>
<div class="paragraph">
<p>В целом Котлин еще был выбран из-за желания попробовать его в реальном проекте. Хайпа вокруг языка достаточно,
да и опыт проб в домашних проектах показывал, что все будет хорошо.</p>
</div>
<div class="paragraph">
<p>Для проекта я выбрал Kotlin + Selenide + Allure + Gradle. Имхо сейчас все инструменты, окромя Котлина, стандарт для
Джава проектов.</p>
</div>
<div class="paragraph">
<p>Костыль первый!</p>
</div>
<div class="paragraph">
<p>Знак <strong>$</strong> является зарезервированным в Котлине, поэтому пришлось написать две обертки:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">fun s(locator: String): SelenideElement {
    return Selenide.`$`(locator)
}

fun ss(locator: String): ElementsCollection {
    return Selenide.`$$`(locator)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Теперь, значит, можно переписать наш <strong>PageObject</strong> на Котлине:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">class LoginPage : Page() {

    override val url: String = "/"

    val userNameInput = s("#username")
    val passwordInput = s("#password")
    val sighInBtn = s("#loginBtn")
    val errorMessage = s("#page__loginByEmail &gt; div:nth-child(3) &gt; div")

    fun loginAs(user: User): MainPage {
        userNameInput.value = user.name
        passwordInput.value = user.password
        sighInBtn.click()
        return MainPage()
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Тест будет выглядеть так:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">class LoginTest {

  @Test
  fun testCanNotLoginWithWrongCredentials() {
     val user = TestData.getUser()

     val loginPage = open(::LoginPage)

     loginPage.loginAs(user)
     loginPage.errorMessage.shouldHave(text("Bad credentials"))
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ты можешь возразить, что ничего особенно не поменялось и будешь абсолютно прав. Для написания Web тестов
особого профита нет. Да, код становится писать чуть-чуть проще, используя <strong>val</strong>.</p>
</div>
<div class="paragraph">
<p>Что неудобно с переходом на Котлин - нужно много делать <strong>static import</strong>. Особенно в случаях с <strong>Conditions.text()</strong>.
Пока что Idea не позволяет импортить это на лету, как в Джаве.</p>
</div>
<div class="paragraph">
<p>Эту штуку в принципе можно легко поправить, добавив BDD style ассерты для Selenide.</p>
</div>
<div class="paragraph">
<p>Пишем метод расширения и реализацию ассертов:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">val SelenideElement.should:ExpextElement get() {
    return ExpextElement(this)
}

class ExpextElement(private val actual: SelenideElement){

    val have: Have = Have()
    val be: Be = Be()

    inner class Have{
        fun text(text:String){
            actual.shouldHave(Condition.text(text))
        }

        fun exactText(text: String?) {
            actual.shouldHave(Condition.exactText(text))
        }
    }

    inner class Be{
        val visible:Unit get() {
            actual.shouldBe(Condition.visible)
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Теперь проверки в Selenide можно писать как старым методом:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">loginPage.siteLogo.shouldBe(visible)
loginPage.errorMessage.shouldHave(text("Bad credentials"))</code></pre>
</div>
</div>
<div class="paragraph">
<p>&#8230;&#8203;так и более Котлин ориентированным:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">loginPage.siteLogo.should.be.visible
loginPage.errorMessage.should.have.text("Bad credentials")</code></pre>
</div>
</div>
<div class="paragraph">
<p>Мне такой варинт нравится по нескольким причинам:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>не нужно постоянно делать static import;</p>
</li>
<li>
<p>работает автокомлит в Idea;</p>
</li>
<li>
<p>коллегам, которые слабо знают Selenide, не нужно объяснять разницу между should, shouldBe и shouldHave.
Я встречал кейсы, где люди пишут <code>element.shouldHave(blank)</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Так, с Web тестами вроде как понятно. Еще покажу пример использования для работы с базой.
Я уже писал <a href="http://automation-remarks.com/2017/kotlin-db/index.html">подобную заметку</a>, но тогда это были первые шаги,
теперь же - как ретроспективка.</p>
</div>
<div class="paragraph">
<p>Значит, нормальной ORM я для Котлина не нашел. Пробовал и <a href="https://github.com/JetBrains/Exposed">Exposed</a>, и
другие, которые можно найти на Github. Некоторые не поддерживают MS SQL Server, некоторые обладают каким-то
упоротым API.</p>
</div>
<div class="paragraph">
<p>Короче говоря, пришлось писать свой велосипед. За основу я взял <strong>Apache DBUtils</strong>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">fun QueryRunner.query(sql: String): List&lt;Map&lt;String, Any?&gt;&gt; {

    val resultSetHandler = ResultSetHandler&lt;List&lt;Map&lt;String, Any?&gt;&gt;&gt; { rs -&gt;
        val meta = rs.metaData
        val cols = meta.columnCount
        val result = arrayListOf&lt;Map&lt;String,Any?&gt;&gt;()

        while (rs.next()) {
            val map = mutableMapOf&lt;String, Any?&gt;()
            for (i in 0 until cols) {
                val columnName = meta.getColumnName(i + 1)
                map[columnName] = rs.getObject(i + 1)
            }
            result.add(map)
        }

        result
    }

    return query(sql,resultSetHandler)
}

inline fun &lt;reified T&gt; QueryRunner.findOne(sql: String): T {
    return BeanHandler(T::class.java).run { query(sql, this) }
}

inline fun &lt;reified T&gt; QueryRunner.findAll(sql: String): MutableList&lt;T&gt; {
    return BeanListHandler(T::class.java).run { query(sql, this) }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Создадим еще классы таблиц как пример:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">data class Suppliers(var id: String? = null,
                     var company: String? = null,
                     var currency: String? = null)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Теперь можно работать с базой:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">fun selectAllSuppliers(): MutableList&lt;Suppliers&gt; {
        val sql = """
             SELECT *
             FROM Suppliers;
             """

        return queryRunner.findAll(sql)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Добавив библиотеку <a href="https://github.com/winterbe/expekt">Expekt</a>, тесты можно писать так:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">class TestDB {

  val db = Database()

  @Test
  fun testCanGetAllSuppliers(){
    db.selectAllSuppliers().should.have.size(3)
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>В этом аспекте все значительно проще. Мне понадобилось добавить пару Extension методов для класса QueryRunner
и прикрутить готовую библиотеку для удобных ассертов.</p>
</div>
<div class="paragraph">
<p>Вывод: пока что впечатления о самом языке Котлин положительные. Интеграция с суровыми
Java библиотеками иногда может вызвать панику. Пару раз у нас Котлин не желал компилироваться и падал со странными
ошибками о том, что Gradle daemon умер. Оказалось, ему просто не хватало Heap памяти. По факту я нашел
в баг трекере тикет на эту проблему и, вроде бы, починилось оно переходом на самую свежую версию Котлина
и Грейдла. Сейчас такого не наблюдается. Тьфу-тьфу.</p>
</div>
<div class="paragraph">
<p>Как видишь, большого преимущества перехода с Джавы на Котлин не наблюдается. Некоторые
вещи становится делать удобнее, но не намного. Буду ли я пробовать делать еще проекты на Котлине?
Пока не могу ответить - все упирается в рынок труда. Найти хороших автоматизаторов, которые могут делать
работу хорошо на Джаве, - сложно. Тех, кто хотя бы как-то видел Котлин, среди них еще меньше.</p>
</div>
<div class="paragraph">
<p>В целом я продолжаю следить за этим языком. Было бы полезно узнать опыт других ребят,
которые пробовали что-то делать на Котлине. Если у тебя такой опыт есть, пиши в комментарии или в личку. Подписывайся на
<a href="https://t.me/automation_remarks">телеграмм канал</a>, чтобы получать самые свежие мысли и соображения на тему автоматизации тестирования.</p>
</div>
                            </section>

                            <footer class="post-footer">
                                   <div class="post-tags">
                                           <a class="btn btn-sm btn-outline-dark tag" href="/tags/Java.html">Java</a>
                                           <a class="btn btn-sm btn-outline-dark tag" href="/tags/Kotlin.html">Kotlin</a>
                                           <a class="btn btn-sm btn-outline-dark tag" href="/tags/TestNG.html">TestNG</a>
                                   </div>

                            </footer>

                            <div class="row pl-3 pr-3 training-banner-container">
                                                                    <div class="col text-center pb-3 pt-2 training-banner">
                                                                        <a href="/trainings">Доступные тренинги по автоматизации тестирования: Java API, Java UI, Python API, Jenkins CI</a>
                                                                    </div>
                                                        </div>

                            <div class="sidebar-social">
                                <h5>Подпишись:</h5>
                                <ul>
                                <li>
                                <a href="https://tttttt.me/automation_remarks" title="Telegram" target="_blank" rel="nofollow">
                                  <i class="fa fa-telegram" aria-hidden="true"></i>
                                  <span>Telegram</span>
                                </a>
                                </li>

                                <li>
                                <a href="https://soundcloud.com/qaguild" title="Podcast" target="_blank" rel="nofollow">
                                  <i class="fa fa-podcast" aria-hidden="true"></i>
                                  <span>Подкаст</span>
                                </a>
                                </li>

                                <li>
                                <a href="https://www.youtube.com/channel/UCHtyBZ2XbtsRmNiAxh48RGg?view_as=subscriber" title="Youtube" target="_blank" rel="nofollow">
                                <i class="fa fa-youtube-play" aria-hidden="true"></i>
                                  <span>Youtube</span>
                                </a>
                                </li>

                                <li>
                                   <a href="https://donatesystem.io/donate/automation_remarks" title="Поддержать" target="_blank" rel="9nofollow">
                                   <i class="fa fa-money" aria-hidden="true"></i>
                                      <span>Поддержать</span>
                                   </a>
                                </li>


                            </div>




                            <div class="row">
                                  <div class="col-md-12">
                                        <div class='related-posts-holder'>
                                             <h2 class="related-posts-header">Похожие заметки:</h2>

                                                 <div class="card-deck">
                                                        <div class="card bg-light mb-3">
                                                            <div class="card-body d-flex flex-column">
                                                              <p class="card-text">
                                                                      <small class="text-muted"><span class="post-date">22 April 2020</span></small>
                                                              </p>
                                                              <h5 class="card-title"><a href="/2020/qaguild-live26/index.html">QAGuild live #26: Selenium UI Automation плагин в Idea для тестировщика</a></h5>

                                                              <hr>

                                                              <p class="card-text">
                                                                   Обзор на Selenium UI Automation плагин в Idea
                                                              </p>

                                                              <a href="/2020/qaguild-live26/index.html" class="mt-auto card-link">
                                                                Читать<i class="fa fa-chevron-right ml-1"></i>
                                                              </a>
                                                            </div>
                                                        </div>
                                                        <div class="card bg-light mb-3">
                                                            <div class="card-body d-flex flex-column">
                                                              <p class="card-text">
                                                                      <small class="text-muted"><span class="post-date">21 April 2020</span></small>
                                                              </p>
                                                              <h5 class="card-title"><a href="/2020/qaguild-s03e06/index.html">QAGuild S03E06: Про работу тестировщиков из дома</a></h5>

                                                              <hr>

                                                              <p class="card-text">
                                                                   Подкаст про работу из дома
                                                              </p>

                                                              <a href="/2020/qaguild-s03e06/index.html" class="mt-auto card-link">
                                                                Читать<i class="fa fa-chevron-right ml-1"></i>
                                                              </a>
                                                            </div>
                                                        </div>
                                                        <div class="card bg-light mb-3">
                                                            <div class="card-body d-flex flex-column">
                                                              <p class="card-text">
                                                                      <small class="text-muted"><span class="post-date">18 April 2020</span></small>
                                                              </p>
                                                              <h5 class="card-title"><a href="/2020/qaguild-live27/index.html">QAGuild live #27: Selenide на Kotlin для тестирования UI</a></h5>

                                                              <hr>

                                                              <p class="card-text">
                                                                   Selenide на Kotlin для тестирования UI
                                                              </p>

                                                              <a href="/2020/qaguild-live27/index.html" class="mt-auto card-link">
                                                                Читать<i class="fa fa-chevron-right ml-1"></i>
                                                              </a>
                                                            </div>
                                                        </div>
                                                        <div class="card bg-light mb-3">
                                                            <div class="card-body d-flex flex-column">
                                                              <p class="card-text">
                                                                      <small class="text-muted"><span class="post-date">10 April 2020</span></small>
                                                              </p>
                                                              <h5 class="card-title"><a href="/2020/qadof/index.html">Online QA BOF для тестировщиков</a></h5>

                                                              <hr>

                                                              <p class="card-text">
                                                                   QA BOF
                                                              </p>

                                                              <a href="/2020/qadof/index.html" class="mt-auto card-link">
                                                                Читать<i class="fa fa-chevron-right ml-1"></i>
                                                              </a>
                                                            </div>
                                                        </div>
                                                 </div>
                                         </div>
                                  </div>
                                  <div class="col-md-6">

                                  </div>
                            </div>
                        </div>
                    </div>
                </article>
            </main>
       </div>
    </div>
    <footer class="text-muted page-footer fixed-bottom">
      <div class="container">

      </div>
    </footer>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="../../js/jquery-3.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script>window.jQuery || document.write('<script src="../../assets/js/vendor/jquery-slim.min.js"><\/script>')</script>
    <script src="../../js/popper.js"></script>
    <script src="../../js/bootstrap.js"></script>
    <script src="../../js/holder.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.0.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="https://w.soundcloud.com/player/api.js"></script>
    <script src="../../js/script.js"></script>
    <script src="https://use.fontawesome.com/e0e0cff5da.js"></script>
    <script async src="https://cse.google.com/cse.js?cx=005666829887305506139:i4vgkrjldvk"></script>
    </body>
</html>