<!DOCTYPE html>
<html lang="ru">
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Автоматизация рутины приоритетнее давления массой">
    <meta name="author" content="Сергей Пирогов">
    <meta name="HandheldFriendly" content="True" />

    <meta property="og:site_name" content="Заметки Автоматизатора">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Будьте осторожны с TestNG лисенерами">
    <meta property="og:image" content="../images/blog-logo.png"/>
    <meta name="referrer" content="origin">

       <meta property="og:description" content="Решил написать такую вот, на мой взгляд, интересную и, наверное, для многих познавательную заметку. Сегодня поговорим о скрытых угрозах, которые несут в себе TestNG лисенеры."/>
    <link rel="canonical" href="http://automation-remarks.com"/>
    <link rel="shortcut icon" href="../images/favicon.ico" type="image/x-icon">
    <link rel="icon" href="../images/favicon.ico" type="image/x-icon">

    <title>Заметки Автоматизатора</title>

    <link href="../css/github.css" rel="stylesheet">
    <!-- Bootstrap core CSS -->
    <link href="../css/bootstrap.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <!-- Custom styles for this template -->
    <link href="../css/album.css" rel="stylesheet">
    <link href="../css/main.css" rel="stylesheet">

    <script>
           (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
           (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
           m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
           })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

           ga('create', 'UA-57010828-1', 'auto');
           ga('send', 'pageview');
    </script>
  <body>
<header>
      <nav class="navbar fixed-top navbar-expand-lg navbar-dark bg-dark">
        <div class='container'>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarTogglerDemo01" aria-controls="navbarTogglerDemo01" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarTogglerDemo01">
          <ul class="navbar-nav mr-auto mt-2 mt-lg-0">
            <li class="nav-item">
              <a class="nav-link" href="/">Главная <span class="sr-only">(current)</span></a>
            </li>

          </ul>
          <ul class="navbar-nav">
             <li class="nav-item">
               <a class="nav-link" target=blank href="https://soundcloud.com/qaguild">Подкаст</a>
             </li>
             <li class="nav-item">
               <a class="nav-link" target=blank href="https://tttttt.me/automation_remarks">Телеграм</a>
             </li>
             <li class="nav-item">
               <a class="nav-link" href="/archive.html">Архив</a>
             </li>
          </ul>
        </div>
        </div>
      </nav>
</header>
	<div class="album py-5 bg-light">
       <div class="post-container container">
            <main class="content" role="main">
                <article class="post">
                    <div class="inner inner-post">
                        <div id="push">
                            <header class="post-header">
                                <span class="post-meta">
                                    <span class="post-author">
                                        <a href="/author/index.html">Сергей Пирогов</a>
                                    </span> |
                                    <span class="post-date">
                                        08/10/2016
                                    </span>
                                </span>
                                <div class="clear"></div>
                                <h1 class="post-title">Будьте осторожны с TestNG лисенерами</h1>
                            </header>

                            <section class="post-content">
                                <div class="paragraph">
<p>Решил написать такую вот, на мой взгляд, интересную и, наверное, для многих познавательную заметку. Сегодня поговорим о скрытых угрозах, которые несут в себе TestNG лисенеры.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="http://learn-automation.com/wp-content/uploads/2015/03/testng.jpg" alt="testng">
</div>
</div>
<div class="paragraph">
<p>Среди автоматизаторов, использующих Java, издавна бушует холивар, что же лучше, TestNg или JUnit. Увы, но дальше банальных переписок в Slack чате или разговоров в холле конференций дело не заходит.</p>
</div>
<div class="paragraph">
<p>Проведя небольшой экспериментальный опрос на прошедшем <a href="http://automation-remarks.com/qafest-2016-rietrospiektiva/">QAFest 2016</a>, я был немного удивлен, что подавляющее большинство на проектах использует именно TestNG. Многим очень нравится TestNG, некоторые считают его намного более удобным, чем, скажем, тот же JUnit. Осмелюсь предположить, что большинство просто никогда не пробовало использовать JUnit чисто из исторических соображений. Пришел на проект, а там уже был TestNg, освоил его - и теперь на любом другом проекте используем то, что нам так привычно.</p>
</div>
<div class="paragraph">
<p>Мой <a href="http://automation-remarks.com/java-video-recorder-1-0-8/">VideoRecoder</a> имеет интеграцию и с TestNG. Я реализовал такую интеграцию с помощью лисенеров, так как это самый простой и гибкий способ. НО, как оказалось, эти лисенеры влекут за собой кучу подводных камней, о которых многие, скорее всего, даже не знали.</p>
</div>
<div class="paragraph">
<p>Я опишу всего лишь два случая, которые лично меня очень сильно удивили и имели серьезное влияние на работу Java VideoRecorder.</p>
</div>
<div class="paragraph">
<p><strong>Факт 1: Аннотация @Listener применяет лисенер ко всем классам</strong></p>
</div>
<div class="paragraph">
<p>Вот такая вот подлость номер один. Скажем, вы написали класс и захотели применить к нему какой-то свой лисенер:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Listeners({VideoListener.class})
class MyAwesomeTests{

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ну, вроде как отлично, запускаем - все работает, радуемся, пишем в резюме, что мы умеем делать такую классную штуку.</p>
</div>
<div class="paragraph">
<p>НО радуемся недолго. Стоит нам написать еще пару-тройку классов с тестами, как мы заметим, что наш лисенер срабатывает и для них, хотя мы их никакими аннотациями не маркали. Вот это подарок!!</p>
</div>
<div class="paragraph">
<p>Вроде бы, ничего страшного, ну, применяется - и что?</p>
</div>
<div class="paragraph">
<p>В случае с рекордером это потенциально могло привести к плохим последствиям. Скажем, у вас есть Test Suite, в котором есть 200-300 тестов. Вы подключаете запись видео и настраиваете его писать все тесты, независимо от того, отмечены они аннотацией <strong>@Video</strong> или нет.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Listeners({VideoListener.class})
public class TestNgVideoExampleTest {

    @BeforeClass
    public void setUp() {
        VideoRecorder.conf().
                .withRecordMode(RecordingMode.All)
                .withVideoSaveMode(VideoSaveMode.All)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Или так:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">./gradlew test -Dvideo.mode=ALL -Dvideo.save.mode=ALL</code></pre>
</div>
</div>
<div class="paragraph">
<p>Запускаете свои тесты и получаете 200-300 видеороликов. Хотя вы рассчитывали записать только один класс, в котором значительно меньшее количество тестов.</p>
</div>
<div class="paragraph">
<p>Естественно, когда я нашел такой баг в своей библиотеке, то начал думать, как это исправить. Решение оказалось таким: нам нужно написать свой метод проверки аннотации для класса, который в данный момент "прослушивается":</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public boolean shouldIntercept(ITestResult result) {
        List&lt;String&gt; listeners = result.getTestContext().getCurrentXmlTest().getSuite().getListeners();
        return listeners.contains(this.getClass().getName()) || shouldIntercept(result.getTestClass().getRealClass(), this.getClass());
    }

public boolean shouldIntercept(Class testClass, Class annotation) {
        Listeners listenersAnnotation = getListenersAnnotation(testClass);
        return listenersAnnotation != null &amp;&amp; asList(listenersAnnotation.value()).contains(annotation);
    }

    private Listeners getListenersAnnotation(Class testClass) {
        Annotation annotation = testClass.getAnnotation(Listeners.class);
        return annotation != null ? (Listeners) annotation :
                testClass.getSuperclass() != null ? getListenersAnnotation(testClass.getSuperclass()) : null;
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>ну, и затем нужно просто использовать этот метод в методах лисенера:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">public class VideoListener extends TestNgListener {

    @Override
    public void onTestStart(ITestResult result) {
        if (shouldIntercept(result)) {
            // code here
        }
    }

    .... another methods</code></pre>
</div>
</div>
<div class="paragraph">
<p>Теперь ваш лисенер будет срабатывать только для тех классов, у которых аннотация <strong>@Listener</strong> содержит <strong>VideoListener.class</strong>.</p>
</div>
<div class="paragraph">
<p>Стоит отметить, что в случае подключения лисенера через <strong>testng.xml</strong>, он таки будет применен ко всему сьюту:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-xml" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;suite name="Suite" parallel="false"&gt;
    &lt;listeners&gt;
        &lt;listener class-name="com.automation.remarks.testng.VideoListener" /&gt;
    &lt;/listeners&gt;

    &lt;test name="Test"&gt;
        &lt;classes&gt;
            &lt;class name="com.testng.TestClass" /&gt;
        &lt;/classes&gt;
    &lt;/test&gt;
&lt;/suite&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Это выглядит логично, так как блок <strong>&lt;listeners&gt;</strong> находится внутри тега <strong>&lt;suite&gt;</strong>.</p>
</div>
<div class="paragraph">
<p><strong>Факт 2: Порядок выполнения лисенеров не гарантируется</strong></p>
</div>
<div class="paragraph">
<p>Второй интересный момент, который принес мне много головной боли.</p>
</div>
<div class="paragraph">
<p>Скажем, вам нужно подключить два лисенера. В моем случае - один, который пишет видео, а второй, который аттачит это самое видео к &lt;mark&gt;Allure&lt;/mark&gt; отчету.</p>
</div>
<div class="paragraph">
<p>Ок, берем и пишем:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">@Listeners({VideoListener.class, AllureListener.class})
class TestClass{
 // tests here
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Кажется, все отлично: один пишет видео, другой по окончании теста аттачит его в отчет. Но выяснилось, что в некоторые моменты происходила непонятная фигня: видео записывалось, но не отображалось в отчете.</p>
</div>
<div class="paragraph">
<p>Оказалось, что это случалось потому, что методы из <strong>AllureListener</strong> вызывались первее. Ну вообще подарок!!!</p>
</div>
<div class="paragraph">
<p>Начав копаться внутри TestNG, я определил, что все лисенеры складываются в Set и потом вызываются. Естественно, что о какой-то очередности речи и быть не может.</p>
</div>
<div class="paragraph">
<p>Как же все-таки гарантировать очередность вызова? Ответ: иметь один лисенер!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">class AllureVideoListener extends VideoListener{

    @Override
    public void onTestFailure(ITestResult result) {
        super.onTestFailure(result);
        attachment(VideoRecorder.getLastRecording())
    }

    @Attachment(value = "video", type = "video/mp4")
    private byte[] attachment(File video) {
        try {
            return Files.readAllBytes(Paths.get(video.getAbsolutePath()));
        } catch (IOException e) {
            log.warning("Allure listener exception" + e);
            return new byte[0];
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Вот так. Да, я мог вызывать метод attachment не в лисенере, а, скажем, в after method и тогда бы не натолкнулся на это. Но, если вдруг окажется так, что порядок выполнения лисенеров для вас будет важен, я вас предупредил =)</p>
</div>
<div class="paragraph">
<p>Такая вот история моей битвы с <strong>TestNG</strong> и его лисенерами. Естественно, что этот кейс может быть слишком узок и вы в своих проектах никогда не натолкнетесь на это. Но это один из тех моментов, когда можно научиться на ошибках других, и весомый пункт в пользу несовершенности TestNg.</p>
</div>
<div class="paragraph">
<p>Субъективное мнение по поводу <strong>TestNG</strong> vs <strong>JUnit</strong>.</p>
</div>
<div class="paragraph">
<p>Лично я очень жду <strong>JUnit 5</strong>, который уже попробовал, но в реальный проект его брать еще рано. Имхо он заткнет TestNG за пояс, нужно лишь немного подождать.</p>
</div>
<div class="paragraph">
<p>Успехов и до новых заметок..</p>
</div>
                            </section>

                            <footer class="post-footer">
                                   <div class="post-tags">
                                           <a class="btn btn-sm btn-outline-dark tag" href="/tags/TestNG.html">TestNG</a>
                                           <a class="btn btn-sm btn-outline-dark tag" href="/tags/Тест-фреймворк.html">Тест фреймворк</a>
                                   </div>

                            </footer>

                            <div class="row pl-3 pr-3 training-banner-container">
                                                                    <div class="col text-center pb-3 pt-2 training-banner">
                                                                        <a href="/trainings">Доступные тренинги по автоматизации тестирования: Java API, Java UI, Python API, Jenkins CI</a>
                                                                    </div>
                                                        </div>

                            <div class="sidebar-social">
                                <h5>Подпишись:</h5>
                                <ul>
                                <li>
                                <a href="https://tttttt.me/automation_remarks" class="telegram" target="_blank" rel="nofollow">
                                  <i class="fa fa-telegram" aria-hidden="true"></i>
                                  <span>Telegram</span>
                                </a>
                                </li>

                                <li>
                                <a href="https://soundcloud.com/qaguild" class="podcast" target="_blank" rel="nofollow">
                                  <i class="fa fa-podcast" aria-hidden="true"></i>
                                  <span>Подкаст</span>
                                </a>
                                </li>

                                <li>
                                <a href="https://www.youtube.com/channel/UCHtyBZ2XbtsRmNiAxh48RGg?view_as=subscriber" class="youtube" target="_blank" rel="nofollow">
                                <i class="fa fa-youtube-play" aria-hidden="true"></i>
                                  <span>Youtube</span>
                                </a>
                                </li>

                                <li>
                                   <a href="https://donatesystem.io/donate/automation_remarks" class="support" target="_blank" rel="9nofollow">
                                   <i class="fa fa-money" aria-hidden="true"></i>
                                      <span>Поддержать</span>
                                   </a>
                                </li>


                            </div>




                            <div class="row">
                                  <div class="col-md-12">
                                        <div class='related-posts-holder'>
                                             <h2 class="related-posts-header">Похожие заметки:</h2>
                                                 <div class="card-deck">

                                                        <div class="card bg-light mb-3">
                                                         <a class="linked-card rel-card h-100" target="blank" href="/2020/black-friday-2020/index.html">
                                                            <div class="related-card card-body d-flex flex-column">
                                                              <p class="card-text">
                                                                      <small class="text-muted"><span class="post-date">30 November 2020</span></small>
                                                              </p>
                                                              <h5 class="card-title">
                                                                  <!-- <a href="/2020/black-friday-2020/index.html"> -->
                                                                    QAGuild: Черная пятница для QA
                                                                  <!-- </a> -->
                                                              </h5>

                                                              <!--
                                                              <p class="card-text">
                                                                   Черная пятница для QA
                                                              </p>
                                                              -->
                                                              <!-- <a href="/2020/black-friday-2020/index.html" class="mt-auto card-link">
                                                                Читать<i class="fa fa-chevron-right ml-1"></i>
                                                              </a> -->
                                                            </div>
                                                            </a>
                                                        </div>


                                                        <div class="card bg-light mb-3">
                                                         <a class="linked-card rel-card h-100" target="blank" href="/2020/qaguild-live44/index.html">
                                                            <div class="related-card card-body d-flex flex-column">
                                                              <p class="card-text">
                                                                      <small class="text-muted"><span class="post-date">26 November 2020</span></small>
                                                              </p>
                                                              <h5 class="card-title">
                                                                  <!-- <a href="/2020/qaguild-live44/index.html"> -->
                                                                    QAGuild live #44: Как IT специалисту правильно составить резюме?
                                                                  <!-- </a> -->
                                                              </h5>

                                                              <!--
                                                              <p class="card-text">
                                                                   В этом эпизоде попробуем написать тесты на Cypress
                                                              </p>
                                                              -->
                                                              <!-- <a href="/2020/qaguild-live44/index.html" class="mt-auto card-link">
                                                                Читать<i class="fa fa-chevron-right ml-1"></i>
                                                              </a> -->
                                                            </div>
                                                            </a>
                                                        </div>


                                                        <div class="card bg-light mb-3">
                                                         <a class="linked-card rel-card h-100" target="blank" href="/2020/qaguild-s03e16/index.html">
                                                            <div class="related-card card-body d-flex flex-column">
                                                              <p class="card-text">
                                                                      <small class="text-muted"><span class="post-date">25 November 2020</span></small>
                                                              </p>
                                                              <h5 class="card-title">
                                                                  <!-- <a href="/2020/qaguild-s03e16/index.html"> -->
                                                                    QAGuild S03E16: Про тестирование игр: от танчиков до казино
                                                                  <!-- </a> -->
                                                              </h5>

                                                              <!--
                                                              <p class="card-text">
                                                                   Подкаст про тестирование игр
                                                              </p>
                                                              -->
                                                              <!-- <a href="/2020/qaguild-s03e16/index.html" class="mt-auto card-link">
                                                                Читать<i class="fa fa-chevron-right ml-1"></i>
                                                              </a> -->
                                                            </div>
                                                            </a>
                                                        </div>


                                                        <div class="card bg-light mb-3">
                                                         <a class="linked-card rel-card h-100" target="blank" href="/2020/qaguild-live43/index.html">
                                                            <div class="related-card card-body d-flex flex-column">
                                                              <p class="card-text">
                                                                      <small class="text-muted"><span class="post-date">18 November 2020</span></small>
                                                              </p>
                                                              <h5 class="card-title">
                                                                  <!-- <a href="/2020/qaguild-live43/index.html"> -->
                                                                    QAGuild live #43: Пробуем Cypress для автотестов
                                                                  <!-- </a> -->
                                                              </h5>

                                                              <!--
                                                              <p class="card-text">
                                                                   В этом эпизоде попробуем написать тесты на Cypress
                                                              </p>
                                                              -->
                                                              <!-- <a href="/2020/qaguild-live43/index.html" class="mt-auto card-link">
                                                                Читать<i class="fa fa-chevron-right ml-1"></i>
                                                              </a> -->
                                                            </div>
                                                            </a>
                                                        </div>

                                                 </div>
                                         </div>
                                  </div>
                                  <div class="col-md-6">

                                  </div>
                            </div>
                        </div>
                    </div>
                </article>
            </main>
       </div>
    </div>
    <footer class="text-muted page-footer fixed-bottom">
      <div class="container">

      </div>
    </footer>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="../js/jquery-3.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script>window.jQuery || document.write('<script src="../../assets/js/vendor/jquery-slim.min.js"><\/script>')</script>
    <script src="../js/popper.js"></script>
    <script src="../js/bootstrap.js"></script>
    <script src="../js/holder.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.0.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="https://w.soundcloud.com/player/api.js"></script>
    <script src="../js/script.js"></script>
    <script src="https://use.fontawesome.com/e0e0cff5da.js"></script>
    <script async src="https://cse.google.com/cse.js?cx=005666829887305506139:i4vgkrjldvk"></script>
    <script src="https://my.hellobar.com/b89babe68c85bfcf7416926983e86b31a9467186.js" type="text/javascript" charset="utf-8" async="async"></script>
    </body>
</html>
